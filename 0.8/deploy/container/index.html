<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>容器化部署 - CloudIaC</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../../css/theme.css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
  <link href="../../css/version-select.css" rel="stylesheet" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "\u5bb9\u5668\u5316\u90e8\u7f72";
    var mkdocs_page_input_path = "deploy/container.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> CloudIaC</a>
        
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <p class="caption"><span class="caption-text">用户文档</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../user-guide/quick-start/">快速入门</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../user-guide/iac-template-develop/">云模板开发</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">产品文档</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../intra/summarize/">概述</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../intra/organization/">组织</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../intra/project/">项目</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../intra/vcs/">VCS</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../intra/template/">模板</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../intra/variable/">变量</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../intra/cloud_account/">资源账号</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../intra/pipeline/">Pipeline</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../intra/env/">环境</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../intra/resource_drift/">漂移检测</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../intra/role/">角色</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../intra/opa/">合规</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">部署文档</span></p>
                <ul class="current">
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">容器化部署</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#1-docker">1. 安装并启动 docker</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#2-docker-compose">2. 安装 docker-compose</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#3">3. 创建部署目录</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#4-docker-composeyml">4. 编写 docker-compose.yml 文件</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#5-env">5. 编写 .env 文件</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#6-docker-compose">6. 启动docker-compose</a>
    </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../host/">手动部署</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../demo-org/">创建演示组织</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../release-notes/">Releases</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">CloudIaC</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>部署文档 &raquo;</li>
        
      
    
    <li>容器化部署</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  
  <hr/>
</div>

          <div role="main">
            <div class="section">
              
                <h1 id="_1">容器部署</h1>
<p>该文档使用容器部署了所有组件，包括 mysql 和 consul，实际生产环境请根据需要进行调整。</p>
<h4 id="1-docker">1. 安装并启动 docker</h4>
<pre><code class="language-bash">curl -fsSL https://get.docker.com | bash -s docker &amp;&amp; \
systemctl enable docker &amp;&amp; \
systemctl start docker
</code></pre>
<h4 id="2-docker-compose">2. 安装 docker-compose</h4>
<pre><code class="language-bash">curl -L https://get.daocloud.io/docker/compose/releases/download/1.29.2/docker-compose-`uname -s`-`uname -m` &gt; /usr/local/bin/docker-compose &amp;&amp; \
chmod +x /usr/local/bin/docker-compose
</code></pre>
<h4 id="3">3. 创建部署目录</h4>
<p>部署目录固定为 /usr/yunji/cloudiac，<strong>不可更改</strong>，更改部署目录会导致执行部署任务失败。</p>
<pre><code class="language-bash">mkdir -p /usr/yunji/cloudiac/var/{consul,mysql} &amp;&amp; cd /usr/yunji/cloudiac/
</code></pre>
<h4 id="4-docker-composeyml">4. 编写 docker-compose.yml 文件</h4>
<p>文件路径 /usr/yunji/cloudiac/docker-compose.yml，内容如下:</p>
<pre><code class="language-yaml"># auto-replace-from: docker/docker-compose.yml
version: &quot;3.2&quot;
services:
  iac-portal:
    container_name: iac-portal
    image: &quot;cloudiac/iac-portal:v0.8.1&quot;
    volumes:
      - type: bind
        source: /usr/yunji/cloudiac/var
        target: /usr/yunji/cloudiac/var
      - type: bind
        source: /usr/yunji/cloudiac/.env
        target: /usr/yunji/cloudiac/.env
    ports:
      - &quot;9030:9030&quot;
    depends_on:
      - mysql
      - consul
    restart: always

  ct-runner:
    container_name: ct-runner
    image: &quot;cloudiac/ct-runner:v0.8.1&quot;
    volumes:
      - type: bind
        source: /usr/yunji/cloudiac/var
        target: /usr/yunji/cloudiac/var
      - type: bind
        source: /usr/yunji/cloudiac/.env
        target: /usr/yunji/cloudiac/.env
      - type: bind
        source: /var/run/docker.sock
        target: /var/run/docker.sock
    ports:
      - &quot;19030:19030&quot;
    depends_on:
      - consul
    restart: always

  ct-worker:
    image: &quot;cloudiac/ct-worker:v0.8.1&quot;
    container_name: &quot;ct-worker-say-hi&quot;
    # 添加该服务只是为了自动 pull 镜像，并不需要后台运行
    command: [&quot;echo&quot;, &quot;hello world!&quot;]
    restart: &quot;no&quot;

  iac-web:
    container_name: iac-web
    image: &quot;cloudiac/iac-web:v0.8.0&quot;
    ports:
      - 80:80
    restart: always
    depends_on:
      - iac-portal

  mysql:
    container_name: mysql
    image: &quot;mysql:8.0&quot;
    command: [
        &quot;--character-set-server=utf8mb4&quot;,
        &quot;--collation-server=utf8mb4_unicode_ci&quot;,
        &quot;--sql_mode=STRICT_TRANS_TABLES,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION&quot;
    ]
    volumes:
      - type: bind
        source: /usr/yunji/cloudiac/var/mysql
        target: /var/lib/mysql
    environment:
      - MYSQL_RANDOM_ROOT_PASSWORD=yes
      - MYSQL_USER
      - MYSQL_PASSWORD
      - MYSQL_DATABASE
    restart: always

  consul:
    container_name: consul
    image: &quot;consul:latest&quot;
    volumes:
      - type: bind
        source: /usr/yunji/cloudiac/var/consul
        target: /consul/data
    ports:
      - &quot;8500:8500&quot;
    command: &gt;
      consul agent -server -bootstrap-expect=1 -ui -bind=0.0.0.0
      -client=0.0.0.0 -enable-script-checks=true -data-dir=/consul/data
    restart: always

</code></pre>
<h4 id="5-env">5. 编写 .env 文件</h4>
<p>文件路径 /usr/yunji/cloudiac/.env，内容如下(<strong>请根据注释修改配置</strong>):</p>
<pre><code class="language-bash"># auto-replace-from: configs/dotenv.sample
# 平台管理员账号密码(均为必填)
# 该账号密码只在系统初始化时使用，后续修改不影响己创建的账号
IAC_ADMIN_EMAIL=&quot;admin@example.com&quot;
# 密码要求长度大于 8 且包含字母、数字、特殊字符
IAC_ADMIN_PASSWORD=&quot;&quot;

# 加密密钥配置(必填)
# 敏感数据使用该密钥进行加密
SECRET_KEY=&quot;&quot;

# IaC 对外提供服务的地址(必填), 示例: http://cloudiac.example.com
# 该地址需要带协议(http/https)，结尾不可以加 &quot;/&quot;
PORTAL_ADDRESS=&quot;&quot;

# consul 地址(必填)，示例: private.host.ip:8500
# 需要配置为机器的内网 ip:port，不可使用 127.0.0.1
CONSUL_ADDRESS=&quot;&quot;

# mysql 配置(必填)
MYSQL_HOST=mysql
MYSQL_PORT=3306
MYSQL_DATABASE=cloudiac
MYSQL_USER=cloudiac
MYSQL_PASSWORD=&quot;mysqlpass&quot;

# portal 服务注册信息配置 (均为必填)
## portal 服务的 IP 地址， 容器化部署时无需修改, 手动部署时配置为内网 IP
SERVICE_IP=iac-portal
## portal 服务注册的 id(需要保证唯一)
SERVICE_ID=iac-portal-01
## portal 服务注册的 tags
SERVICE_TAGS=&quot;iac-portal;portal-01&quot;

# logger 配置
LOG_DEVEL=&quot;debug&quot;

# SMTP 配置(该配置只影响邮件通知的发送，不配置不影响其他功能)
SMTP_ADDRESS=smtp.example.com:25
SMTP_USERNAME=user@example.com
SMTP_PASSWORD=&quot;&quot;
SMTP_FROM_NAME=IaC
SMTP_FROM=support@example.com

# KAFKA配置(kafka 任务结果回调使用，不配置不影响其他功能)
KAFKA_TOPIC=&quot;IAC_TASK_REPLY&quot;
KAFKA_GROUP_ID=&quot;&quot;
KAFKA_PARTITION=0
## example: KAFKA_BROKERS: [&quot;kafka.example.com:9092&quot;, &quot;...&quot;]
KAFKA_BROKERS=[]
KAFKA_SASL_USERNAME=&quot;&quot;
KAFKA_SASL_PASSWORD=&quot;&quot;


######### 以下为 runner 配置 #############
# runner 服务注册配置(均为必填)
## runner 服务的 IP 地址， 容器化部署时无需修改, 手动部署时配置为内网 IP
RUNNER_SERVICE_IP=ct-runner
## runner 服务注册的 id(需要保证唯一)
RUNNER_SERVICE_ID=ct-runner-01
RUNNER_SERVICE_TAGS=&quot;ct-runner;runner-01&quot;

## 是否开启 offline mode，默认为 false
RUNNER_OFFLINE_MODE=&quot;false&quot;

</code></pre>
<p><em>通过 .env 可以配置大部分参数，需要更详细的配置可以拷贝镜像里的 config-portal.yml 和 config-runner.yml 文件，修改后再挂载到容器中进行替换</em></p>
<h4 id="6-docker-compose">6. 启动docker-compose</h4>
<pre><code class="language-bash">docker-compose up -d

# 前台调试启动：
# dokcker-compose up
</code></pre>
<p><em>至此服务部署完成，如果需要快速创建演示组织请参考文档: <a href="../demo-org/">创建演示组织</a></em></p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../host/" class="btn btn-neutral float-right" title="手动部署">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../../intra/opa/" class="btn btn-neutral" title="合规"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../../intra/opa/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../host/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../js/version-select.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
